<!-- DONE : entities를 별도의 소스 파일로 분리시킴 -->

<meta charset="UTF-8">
<canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"></canvas>
<script src="./js/entities.js"></script>
<script>

// -----------------------------------------------------------------------------
// 상수
var WIDTH       = 500;
var HEIGHT      = 500;

// -----------------------------------------------------------------------------
// 전역 객체
var ctx = document.getElementById("ctx").getContext("2d");
ctx.font = '30px Arial';

var timeWhenGameStarted = Date.now(); // 게임시작 시간 저장
var frameCount  = 0;
var score       = 0;

// -----------------------------------------------------------------------------
// 유틸리티

// 박스와 박스 충돌 테스트
testCollisionRectRect = function( rect1, rect2 ) {
return rect1.x <= rect2.x+rect2.width
    && rect2.x <= rect1.x+rect1.width
    && rect1.y <= rect2.y+rect2.height
    && rect2.y <= rect1.y+rect1.height;
}

// -----------------------------------------------------------------------------
// 이벤트 리스너

// 마우스 이동 이벤트 처리
document.onmousemove = function( mouse ) {
    var mouseX = mouse.clientX - document.getElementById('ctx').getBoundingClientRect().left;
    var mouseY = mouse.clientY - document.getElementById('ctx').getBoundingClientRect().top;

    mouseX -= player.x;
    mouseY -= player.y;
    player.aimAngle = Math.atan2(mouseY,mouseX) / Math.PI * 180;
}

// 마우스 좌클릭
document.onclick = function( mouse ) {
    player.performAttack();
}

// 마우스 우클릭
document.oncontextmenu = function( mouse ) {
    player.performSpecialAttack();
    mouse.preventDefault(); // 컨텍스트 메뉴를 제거한다.
}

// 키보드 키 다운 이벤트
document.onkeydown = function( event ) {
    //console.log(evnet.keyCode);
    // 자바스크립트 키코드 표 : http://www.cambiaresearch.com/articles/15/javascript-char-codes-key-codes
    if( event.keyCode === 68 ) {        // d
        player.pressingRight = true;
    } else if( event.keyCode === 83 ) { // s
        player.pressingDown = true;
    } else if( event.keyCode === 65 ) { // a
        player.pressingLeft = true;
    } else if( event.keyCode === 87 ) { // w
        player.pressingUp = true;
    }
}

// 키보드 키 업 이벤트
document.onkeyup = function( event ) {
    if( event.keyCode === 68 ) {        // d
        player.pressingRight = false;
    } else if( event.keyCode === 83 ) { // s
        player.pressingDown = false;
    } else if( event.keyCode === 65 ) { // a
        player.pressingLeft = false;
    } else if( event.keyCode === 87 ) { // w
        player.pressingUp = false;
    }
}

// -----------------------------------------------------------------------------
// 게임 프로세스 함수들

// update
update = function () {
    ctx.clearRect(0,0,WIDTH,HEIGHT); // 영역 삭제

    ++frameCount;
    ++score;

    // 적군 생성
    if( frameCount % 100 === 0 ) // 4초 마다 = 100/25fps
        randomlyGenerateEnemy();

    // 강화 아이템 생성
    if( frameCount % 75 === 0 ) // 3초 마다 = 75/25fps
        randomlyGenerateUpgrade();

    // 탄환 갱신
    for( var key in bullets ) {
        bullets[key].update();
    }

    // 강화 아이템 갱신
    for( var key in upgrades ) {
        upgrades[key].update();
    }

    // 적군 갱신
    for( var key in enemies ) {
        enemies[key].update();
    }

    // 플레이어 갱신
    player.update();

    ctx.fillText(player.hp + " Hp", 0, 30 );
    ctx.fillText("Score: " + score, 200, 30 );
}

// 새로운 게임 시작
startNewGame = function() {
    player.hp           = 10;
    frameCount          = 0;
    score               = 0;
    enemies             = {};
    upgrades            = {};
    bullets             = {};
    timeWhenGameStarted = Date.now();

    randomlyGenerateEnemy();
    randomlyGenerateEnemy();
    randomlyGenerateEnemy();
}

// -----------------------------------------------------------------------------
// 메인 프로세스

// 플레이어 생성
player = Player();
// 게임 시작
startNewGame();
// 메인루프
setInterval( update, 40 ); // 1000/40=25fps

</script>