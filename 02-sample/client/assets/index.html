<meta charset="UTF-8">
<canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"></canvas>

<!-- 채팅출력창 -->
<div id="chat-text" style="width:500px;height:100px;overflow-y:scroll">
    <div>Hello!</div>
</div>

<!-- 채팅입력창 -->
<form id="chat-form">
    <input id="chat-input" type="text" style="width:500px"></input>
</form>

<!-- https://cdnjs.com/ 에서 socket.io를 검색하여 원하는 버전을 사용한다.-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
<script>

var ctx         = document.getElementById("ctx").getContext("2d"); // 캔버스 컨텍스트
var chatText    = document.getElementById('chat-text'   ); // 채팅 출력 문자열
var chatForm    = document.getElementById('chat-form'   ); // 채팅 입력 폼
var chatInput   = document.getElementById('chat-input'  ); // 채팅 입력 입력창

ctx.font = '20px Arial';

// 서버에 접속한다.
var socket = io();

// -----------------------------------------------------------------------------
// 서버로 부터 데이터를 수신한다.
socket.on('newPositions',function(data){
    ctx.clearRect(0,0,500,500);

    ctx.save();
    ctx.fillStyle = 'green';
    for( var c=0; c<data.player.length; ++c ) {
        ctx.fillRect(data.player[c].x-10, data.player[c].y-10, 20, 20 );
    }
    ctx.fillStyle = 'yellow';
    for( var c=0; c<data.player.length; ++c ) {
        ctx.fillText(data.player[c].name,data.player[c].x-5,data.player[c].y+7);
    }
    ctx.fillStyle = 'red';
    for( var c=0; c<data.bullet.length; ++c ) {
        ctx.fillRect(data.bullet[c].x-5, data.bullet[c].y-5, 10, 10 );
    }
    ctx.restore();
});

// -----------------------------------------------------------------------------
// 채팅 메시지를 채팅메시지 리스트에 추가한다.
socket.on('addChat',function(data){
    chatText.innerHTML += `<div>${data}</div>`;
});

// -----------------------------------------------------------------------------
// 서버에 채팅 메시지를 전송한다.
chatForm.onsubmit = function(e) {
    e.preventDefault(); // 이벤트 전파를 막지 않고 이벤트 취소
    socket.emit( 'sendChat', chatInput.value );
    chatInput.value = '';
}

// -----------------------------------------------------------------------------
// 키보드 키 다운 이벤트
document.onkeydown = function( event ) {
    //console.log(evnet.keyCode);
    // 자바스크립트 키코드 표 : http://www.cambiaresearch.com/articles/15/javascript-char-codes-key-codes
    if( event.keyCode === 68 ) {        // d
        socket.emit('keyPress',{ inputId:'right',state:true });
    } else if( event.keyCode === 83 ) { // s
        socket.emit('keyPress',{ inputId:'down',state:true });
    } else if( event.keyCode === 65 ) { // a
        socket.emit('keyPress',{ inputId:'left',state:true });
    } else if( event.keyCode === 87 ) { // w
        socket.emit('keyPress',{ inputId:'up',state:true });
    }
}

// -----------------------------------------------------------------------------
// 키보드 키 업 이벤트
document.onkeyup = function( event ) {
    if( event.keyCode === 68 ) {        // d
        socket.emit('keyPress',{ inputId:'right',state:false });
    } else if( event.keyCode === 83 ) { // s
        socket.emit('keyPress',{ inputId:'down',state:false });
    } else if( event.keyCode === 65 ) { // a
        socket.emit('keyPress',{ inputId:'left',state:false });
    } else if( event.keyCode === 87 ) { // w
        socket.emit('keyPress',{ inputId:'up',state:false });
    }
}
</script>
