<meta charset="UTF-8">
<canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"></canvas>

<!-- 채팅출력창 -->
<div id="chat-text" style="width:500px;height:100px;overflow-y:scroll">
    <div>Hello!</div>
</div>

<!-- 채팅입력창 -->
<form id="chat-form">
    <input id="chat-input" type="text" style="width:500px"></input>
</form>

<!-- https://cdnjs.com/ 에서 socket.io를 검색하여 원하는 버전을 사용한다.-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
<script>

var ctx         = document.getElementById("ctx").getContext("2d"); // 캔버스 컨텍스트
var chatText    = document.getElementById('chat-text'   ); // 채팅 출력 문자열
var chatForm    = document.getElementById('chat-form'   ); // 채팅 입력 폼
var chatInput   = document.getElementById('chat-input'  ); // 채팅 입력 입력창

ctx.font = '20px Arial';

// 서버에 접속한다.
var socket = io();

// -----------------------------------------------------------------------------
// 서버로 부터 데이터를 수신한다.
socket.on('newPositions',function(data){
    ctx.clearRect(0,0,500,500);

    ctx.save();
    ctx.fillStyle = 'green';
    for( var c=0; c<data.player.length; ++c ) {
        var player = data.player[c];
        ctx.fillRect(player.x-player.width/2, player.y-player.height/2, player.width, player.height );
    }
    ctx.fillStyle   = 'yellow';
    ctx.textAlign   = 'center';
    ctx.textBaseline= 'middle';
    for( var c=0; c<data.player.length; ++c ) {
        var player = data.player[c];
        ctx.fillText(player.name,player.x,player.y);
    }
    ctx.fillStyle = 'red';
    for( var c=0; c<data.bullet.length; ++c ) {
        bullet = data.bullet[c];
        ctx.fillRect(bullet.x-bullet.width/2, bullet.y-bullet.height/2, bullet.width, bullet.height );
    }
    ctx.restore();
});

// -----------------------------------------------------------------------------
// 채팅 메시지를 채팅메시지 리스트에 추가한다.
socket.on('addChat',function(data){
    chatText.innerHTML += `<div>${data}</div>`;
});

// -----------------------------------------------------------------------------
// 서버로 부터 eval 결과를 수신 받는다.
socket.on('resEval',function(data){
    console.log(data);
});

// -----------------------------------------------------------------------------
// 서버에 채팅 메시지를 전송한다.
chatForm.onsubmit = function(e) {
    e.preventDefault(); // 이벤트 전파(상위에 테그들에 전달)를 막지 않고 이벤트 실행 취소

    // 서버측에서 코드 실행을하고 결과를 받는다.
    if( chatInput.value[0] === '/' )
        socket.emit( 'reqEval', chatInput.value.slice(1) );
    else
        socket.emit( 'sendChat', chatInput.value );
    chatInput.value = '';
}


// -----------------------------------------------------------------------------
// 키보드 키 다운 이벤트
document.onkeydown = function( event ) {
    console.log(event.keyCode);
    // 자바스크립트 키코드 표 : http://www.cambiaresearch.com/articles/15/javascript-char-codes-key-codes
    if( event.keyCode === 68 ) {        // d
        socket.emit('keyPress',{ inputId:'right',state:true });
    } else if( event.keyCode === 83 ) { // s
        socket.emit('keyPress',{ inputId:'down',state:true });
    } else if( event.keyCode === 65 ) { // a
        socket.emit('keyPress',{ inputId:'left',state:true });
    } else if( event.keyCode === 87 ) { // w
        socket.emit('keyPress',{ inputId:'up',state:true });
    }
}

// -----------------------------------------------------------------------------
// 키보드 키 업 이벤트
document.onkeyup = function( event ) {
    if( event.keyCode === 68 ) {        // d
        socket.emit('keyPress',{ inputId:'right',state:false });
    } else if( event.keyCode === 83 ) { // s
        socket.emit('keyPress',{ inputId:'down',state:false });
    } else if( event.keyCode === 65 ) { // a
        socket.emit('keyPress',{ inputId:'left',state:false });
    } else if( event.keyCode === 87 ) { // w
        socket.emit('keyPress',{ inputId:'up',state:false });
    }
}

// -----------------------------------------------------------------------------
// 마우스 좌클릭 다운 이벤트
document.onmousedown = function( event ) {
    if(event.which === 1 )
        socket.emit( 'keyPress', {inputId:'attack',state:true});
    else
        socket.emit( 'keyPress', {inputId:'specialAttack',state:true});
}

// -----------------------------------------------------------------------------
// 마우스 좌클릭 업 이벤트
document.onmouseup = function( event ) {
    if(event.which === 1 )
        socket.emit( 'keyPress', {inputId:'attack',state:false});
    else
        socket.emit( 'keyPress', {inputId:'specialAttack',state:false});
}

// -----------------------------------------------------------------------------
// 마우스 좌표 이동 이벤트
document.onmousemove = function( event ) {
    var x = -250 + event.clientX - 8;
    var y = -250 + event.clientY - 8;
    var angle = Math.atan2(y,x) / Math.PI * 180; // atan2(y,x) : x축에 대한 좌표의 각도를 라디안값으로 얻는다. ( https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/atan2 )
    socket.emit( 'keyPress', {inputId:'attackAngle',state:angle})
}

// -----------------------------------------------------------------------------
// 마우스 우클릭 이벤트
document.oncontextmenu = function( mouse ) {
    mouse.preventDefault(); // 컨텍스트 메뉴를 제거한다.
}

</script>
